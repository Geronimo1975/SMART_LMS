{% extends "base.html" %}

{% block title %}{{ course.title }} - UNI_online{% endblock %}
{% block header_title %}{{ course.code }}: {{ course.title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Course Information</h3>
                <div>
                    {% if user.role == 'teacher' and user == course.teacher %}
                    <a href="{% url 'course_edit' pk=course.pk %}" class="btn btn-sm btn-secondary">
                        <i class="fas fa-edit"></i> Edit Course
                    </a>
                    <a href="{% url 'course_delete' pk=course.pk %}" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i> Delete Course
                    </a>
                    {% elif user.role == 'student' %}
                        {% if user.enrollments.filter(course=course, is_active=True).exists %}
                        <a href="{% url 'unenroll_from_course' course_id=course.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to unenroll from this course?')">
                            <i class="fas fa-user-minus"></i> Unenroll
                        </a>
                        {% else %}
                        <a href="{% url 'enroll_in_course' course_id=course.pk %}" class="btn btn-sm btn-success">
                            <i class="fas fa-user-plus"></i> Enroll
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h4>Description</h4>
                    <p>{{ course.description }}</p>
                    
                    <h4 class="mt-4">Course Details</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Course Code:</strong> {{ course.code }}</p>
                            <p><strong>Teacher:</strong> {{ course.teacher.get_full_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Start Date:</strong> {{ course.start_date|date:"F d, Y" }}</p>
                            <p><strong>End Date:</strong> {{ course.end_date|date:"F d, Y" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    {% if course.teacher.profile.avatar %}
                    <div class="text-center mb-3">
                        <img src="{{ course.teacher.profile.avatar.url }}" alt="{{ course.teacher.get_full_name }}" class="avatar avatar-xl">
                        <h5 class="mt-2">{{ course.teacher.get_full_name }}</h5>
                        {% if course.teacher.profile.title %}
                        <p>{{ course.teacher.profile.title }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if user.role == 'teacher' and user == course.teacher %}
                    <div class="card">
                        <div class="card-body">
                            <h5>Student Enrollment</h5>
                            <p><strong>Enrolled Students:</strong> {{ course.student_count }}</p>
                            <a href="{% url 'manage_students' course_id=course.pk %}" class="btn btn-primary btn-sm btn-block">
                                <i class="fas fa-users-cog"></i> Manage Students
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assignments Section -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Assignments</h3>
                {% if user.role == 'teacher' and user == course.teacher %}
                <a href="{% url 'assignment_create' course_id=course.pk %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus-circle"></i> Add Assignment
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if assignments %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Due Date</th>
                            <th>Points</th>
                            {% if user.role == 'student' %}
                            <th>Status</th>
                            {% endif %}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for assignment in assignments %}
                        <tr>
                            <td>{{ assignment.title }}</td>
                            <td>{{ assignment.due_date|date:"M d, Y h:i A" }}</td>
                            <td>{{ assignment.total_points }}</td>
                            {% if user.role == 'student' %}
                            <td>
                                {% if assignment.pk in submission_map %}
                                    {% with submission=submission_map|get_item:assignment.pk %}
                                        {% if submission.is_graded %}
                                        <span class="badge badge-success">Graded</span>
                                        {% else %}
                                        <span class="badge badge-info">Submitted</span>
                                        {% endif %}
                                    {% endwith %}
                                {% elif assignment.is_past_due %}
                                <span class="badge badge-danger">Missing</span>
                                {% else %}
                                <span class="badge badge-warning">Not Submitted</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td>
                                <a href="{% url 'assignment_detail' pk=assignment.pk %}" class="btn btn-sm btn-primary">View</a>
                                {% if user.role == 'teacher' and user == course.teacher %}
                                <a href="{% url 'assignment_edit' pk=assignment.pk %}" class="btn btn-sm btn-secondary">Edit</a>
                                <a href="{% url 'assignment_delete' pk=assignment.pk %}" class="btn btn-sm btn-danger">Delete</a>
                                {% elif user.role == 'student' %}
                                <a href="{% url 'submission_create' assignment_id=assignment.pk %}" class="btn btn-sm btn-success">
                                    {% if assignment.pk in submission_map %}Update{% else %}Submit{% endif %}
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>No assignments for this course yet.</p>
            {% if user.role == 'teacher' and user == course.teacher %}
            <a href="{% url 'assignment_create' course_id=course.pk %}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Add First Assignment
            </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Materials Section -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Course Materials</h3>
                {% if user.role == 'teacher' and user == course.teacher %}
                <a href="{% url 'material_create' course_id=course.pk %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus-circle"></i> Add Material
                </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if materials %}
            <div class="row">
                {% for material in materials %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ material.title }}</h5>
                            <p class="card-text">{{ material.description|truncatechars:100 }}</p>
                            <div class="mt-auto">
                                <span class="badge badge-secondary">
                                    {% if material.material_type == 'file' %}
                                    <i class="fas fa-file"></i> File
                                    {% elif material.material_type == 'link' %}
                                    <i class="fas fa-link"></i> Link
                                    {% else %}
                                    <i class="fas fa-align-left"></i> Text
                                    {% endif %}
                                </span>
                                <span class="text-muted ml-2">{{ material.uploaded_at|date:"M d, Y" }}</span>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'material_detail' pk=material.pk %}" class="btn btn-sm btn-primary">View</a>
                            {% if user.role == 'teacher' and user == course.teacher %}
                            <a href="{% url 'material_edit' pk=material.pk %}" class="btn btn-sm btn-secondary">Edit</a>
                            <a href="{% url 'material_delete' pk=material.pk %}" class="btn btn-sm btn-danger">Delete</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No materials for this course yet.</p>
            {% if user.role == 'teacher' and user == course.teacher %}
            <a href="{% url 'material_create' course_id=course.pk %}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Add First Material
            </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
